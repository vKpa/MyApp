{% extends "todo/base.html" %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <h2>タスク</h2>
    <a href="{% url 'task_create' %}" class="btn btn-primary mb-3">新規作成</a>

    <form method="get" class="mb-4">
      <div class="row g-3">
        <div class="col-md-3">
          <input type="text" class="form-control" name="search" value="{{ search_query|default_if_none:'' }}" placeholder="タスクを検索">
        </div>
        <div class="col-md-2">
          <select name="category" class="form-select">
            <option value="">すべてのカテゴリ</option>
            {% for category in categories %}
              <option value="{{ category.id }}" {% if category.id|stringformat:"s" == current_category %}selected{% endif %}>
                {{ category.name }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <select name="priority" class="form-select">
            <option value="">すべての優先度</option>
            <option value="high" {% if current_priority == 'high' %}selected{% endif %}>高</option>
            <option value="medium" {% if current_priority == 'medium' %}selected{% endif %}>中</option>
            <option value="low" {% if current_priority == 'low' %}selected{% endif %}>低</option>
          </select>
        </div>
        <div class="col-md-2">
          <select name="completed" class="form-select">
            <option value="">すべてのステータス</option>
            <option value="True" {% if current_completed == 'True' %}selected{% endif %}>完了</option>
            <option value="False" {% if current_completed == 'False' %}selected{% endif %}>未対応</option>
          </select>
        </div>
        <div class="col-md-2">
          <select name="sort" class="form-select">
            <option value="created_date" {% if current_sort == 'created_date' %}selected{% endif %}>作成日（最新）</option>
            <option value="due_date" {% if current_sort == 'due_date' %}selected{% endif %}>期日（昇順）</option>
            <option value="-due_date" {% if current_sort == '-due_date' %}selected{% endif %}>期日（降順）</option>
            <option value="priority" {% if current_sort == 'priority' %}selected{% endif %}>優先度</option>
          </select>
        </div>
        <div class="col-md-1">
          <button type="submit" class="btn btn-secondary">適用</button>
        </div>
      </div>
    </form>

    <table class="table">
      <thead>
        <tr>
          <th>タイトル</th>
          <th>優先度</th>
          <th>カテゴリ</th>
          <th>期日</th>
          <th>アクション</th>
        </tr>
      </thead>
      <tbody>
        {% for task in page_obj %}
          <tr class="{% if task.completed %}text-decoration-line-through{% endif %}">
            <td><a href="{% url 'task_detail' task.pk %}">{{ task.title }}</a></td>
            <td>{{ task.get_priority_display }}</td>
            <td>{% if task.category %}{{ task.category.name }}{% endif %}</td>
            <td>{{ task.due_date|date:"Y-m-d H:i" }}</td>
            <td>
              <button class="toggle-complete btn btn-sm btn-outline-primary" data-task-id="{{ task.pk }}">
                {% if task.completed %}未対応にする{% else %}完了にする{% endif %}
              </button>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="5">タスクがありません</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?page=1">&laquo; 最初</a></li>
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">前</a></li>
        {% endif %}

        <li class="page-item disabled"><a class="page-link" href="#">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</a></li>

        {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">次</a></li>
          <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">最後 &raquo;</a></li>
        {% endif %}
      </ul>
    </nav>
  </div>
</div>
{% endblock %}